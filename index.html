<!-- Final corrected Energy Tracker HTML -->
<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>ç¯€èƒ½ç¿’æ…£è¿½è¹¤å™¨</title>
  <style>
  :root{ --bg:#f7f5ee; --card:#fff; --accent:#2a7b3f; --muted:#6b6b6b }
  *{box-sizing:border-box}
  body{margin:0;font-family:"Noto Sans TC",Arial,sans-serif;background:var(--bg);color:#222;padding:18px}
  header{max-width:900px;margin:0 auto 14px;text-align:center}
  h1{margin:6px 0;color:var(--accent)}
  .subtitle{margin:0 0 8px;color:var(--muted)}
  nav{display:flex;gap:8px;justify-content:center;margin-bottom:6px}
  nav button{padding:8px 12px;border-radius:8px;border:1px solid #ddd;background:white;cursor:pointer;color:#222;font-weight:600}
  nav button:hover{transform:scale(1.02)}
  .page{max-width:900px;margin:0 auto 30px}
  .hidden{display:none}
  .card{background:var(--card);padding:16px;border-radius:10px;box-shadow:0 6px 18px rgba(0,0,0,0.06);margin-bottom:14px}
  .row{display:flex;justify-content:space-between;align-items:center;gap:10px}
  .small{font-size:0.95rem}
  .muted{color:var(--muted)}
  .task-list{display:flex;flex-direction:column;gap:8px;margin-top:8px}
  .task{display:flex;justify-content:space-between;align-items:center;padding:10px;background:#fff8e6;border-radius:8px;border:1px solid #eedcaa}
  .task .name{font-weight:600}
  .task .points{color:var(--muted)}
  button{border:none;background:#1976d2;color:white;padding:8px 12px;border-radius:8px;cursor:pointer}
  button[disabled]{background:#bdbdbd;cursor:not-allowed}
  textarea{width:100%;min-height:64px;margin-top:8px;padding:8px;border-radius:6px;border:1px solid #ddd}
  .track{height:48px;background:linear-gradient(90deg,#eee,#f8f8f8);border-radius:24px;position:relative;margin:12px 0;overflow:hidden;border:1px solid #e0e0e0}
  .walker{position:absolute;left:8px;top:50%;transform:translateY(-50%);font-size:28px;transition:left 800ms ease}
  .track::before{content:"";position:absolute;left:0;right:0;top:0;bottom:0;background-image:repeating-linear-gradient(90deg,rgba(0,0,0,0.03) 0 1px,transparent 1px 40px);opacity:0.6;border-radius:24px}
  .footer{max-width:900px;margin:0 auto;text-align:center;color:var(--muted);font-size:0.9rem}
  .history-item{padding:10px;border-bottom:1px solid #eee}
  .history-item .date{font-weight:700}
  .pager{display:flex;gap:8px;align-items:center;justify-content:center;margin-top:12px}
  </style>
</head>
<body>
  <header>
    <h1>ç¯€èƒ½ç¿’æ…£è¿½è¹¤å™¨</h1>
    <p class="subtitle">å°ç¿’æ…£å¸¶ä¾†å¤§å½±éŸ¿ â€” SDGs 7 / 11 / 13</p>
    <nav>
      <button id="nav-home">ğŸ  é¦–é </button>
      <button id="nav-history">ğŸ“˜ æ­·å²ç´€éŒ„</button>
      <button id="nav-medals">ğŸ… çç‰Œç´€éŒ„</button>
    </nav>

    <section class="card" id="fixed-animation">
      <h3>æœ¬é€±é€²åº¦èˆ‡èµ°è·¯å°å‹•ç•«</h3>
      <div id="track" class="track"><div id="walker" class="walker">ğŸš¶â€â™‚ï¸</div></div>
      <div class="row small">
        <div>ä»Šæ—¥å¾—åˆ†ï¼š<span id="today-points">0</span> é»</div>
        <div>é€²åº¦ï¼š<span id="week-points-2">0</span>/<span id="weekly-goal-2"></span></div>
      </div>
      <div id="medal-note" class="small muted"></div>
    </section>
  </header>

  <main id="page-home" class="page">
    <section class="card">
      <div class="row">
        <div><strong>æœ¬é€±ä¸Šé™ï¼š</strong><span id="weekly-goal-label"></span> é»</div>
        <div><strong>æœ¬é€±ç´¯ç©ï¼š</strong><span id="week-points">0</span> é»</div>
      </div>

      <h2>ä»Šå¤©çš„ç¯€èƒ½è¡Œç‚º</h2>
      <div id="task-list" class="task-list"></div>

      <label for="note">ä»Šæ—¥å‚™è¨»ï¼ˆé¸å¡«ï¼‰</label>
      <textarea id="note" placeholder="å¯«ä¸‹ä»Šå¤©çš„å°ç¿’æ…£æˆ–å¿ƒå¾—..."></textarea>

      <div class="controls"><button id="save-btn">å„²å­˜ä»Šå¤©çš„ç´€éŒ„</button></div>
    </section>
  </main>

  <main id="page-history" class="page hidden">
    <section class="card">
      <h2>æ­·å²ç´€éŒ„</h2>
      <div id="history-list"></div>
      <div class="pager"><button id="prev-page">ä¸Šä¸€é </button><span id="page-info"></span><button id="next-page">ä¸‹ä¸€é </button></div>
    </section>
  </main>

  <main id="page-medals" class="page hidden">
    <section class="card">
      <h2>çç‰Œç´€éŒ„</h2>
      <div id="medal-list"></div>
    </section>
  </main>

  <audio id="save-sound" src="https://cdn.pixabay.com/audio/2022/03/15/audio_7c34bc587a.mp3" preload="auto"></audio>

  <footer class="footer"><small>æ¯é€±å¾é€±ä¸€ 00:00 ç‚ºæ–°é€±ï¼›ä¸€é€±é”æ¨™å°‡è‡ªå‹•é ˜å–çç‰Œã€‚</small></footer>

<script>
/* --- Corrected JS --- */
const WEEKLY_GOAL = 100;
const STORAGE_KEY = "energy_tracker_v4";

const ENCOURAGE = [
  "ä½ çš„åŠªåŠ›æ­£åœ¨è®“åœ°çƒè®Šå¾—æ›´å¥½ï¼",
  "æ¯ä¸€æ¬¡ç¯€èƒ½ï¼Œéƒ½è®“æœªä¾†æ›´å…‰æ˜ï¼",
  "å¤ªæ£’äº†ï¼ä½ æ­£åœ¨å‰µé€ æ›´ç¶ è‰²çš„ç”Ÿæ´»ï¼",
  "ä½ çš„å …æŒçœŸçš„ä»¤äººä½©æœï¼",
  "ä½ åšçš„æ¯ä¸€æ­¥éƒ½åœ¨ç‚ºåœ°çƒåŠ åˆ†ï¼",
  "æŒçºŒåŠªåŠ›ï¼Œç’°å¢ƒä¸€å®šæœƒå›å ±ä½ ï¼",
  "å¾ˆæ£’çš„å …æŒï¼ä½ çš„å½±éŸ¿æ¯”ä½ æƒ³åƒçš„å¤§ï¼",
  "ä½ æ˜¯ç¯€èƒ½çš„å°è‹±é›„ï¼",
  "è¶…å¼·ï¼ä½ çš„è¡Œå‹•æ­£åœ¨æ”¹è®Šæ¯å¤©ï¼"
];
function getRandomMsg(){ return ENCOURAGE[Math.floor(Math.random()*ENCOURAGE.length)]; }

const TASKS = [
  { name: "éš¨æ‰‹é—œç‡ˆ", points: 3 },
  { name: "æ‹”é™¤æœªä½¿ç”¨æ’é ­", points: 2 },
  { name: "æ¸›å°‘å†·æ°£ä½¿ç”¨", points: 5 },
  { name: "èª¿é«˜å†·æ°£æº«åº¦åˆ° 26 åº¦ä»¥ä¸Š", points: 2 },
  { name: "ç¸®çŸ­æ´—æ¾¡æ™‚é–“", points: 3 },
  { name: "æ”¶é›†é›¨æ°´/æ´—ç±³æ°´æ¾†èŠ±æˆ–æ¸…æ½”", points: 2 },
  { name: "å°‡èˆŠè¡£æœæ”¹é€ æˆç’°ä¿è¢‹æˆ–æŠ¹å¸ƒ", points: 2 },
  { name: "ç”¨æ‰‹å¸•å–ä»£ä¸€æ¬¡æ€§ç´™å·¾", points: 2 },
  { name: "ä¸ä½¿ç”¨æ™‚é—œé–‰é›»è…¦è¢å¹•", points: 1 },
  { name: "æ¸›å°‘é›»æ¢¯æ­ä¹˜ï¼ˆæ”¹èµ°æ¨“æ¢¯ï¼‰", points: 3 },
  { name: "ç”¨èˆŠç›’å­ã€ç“¶å­åšæ‰‹ä½œæˆ–æ”¶ç´ï¼Œæ¸›å°‘ä¸Ÿæ£„", points: 2 },
  { name: "ä½¿ç”¨è‡ªå‚™ç’°ä¿é¤å…·", points: 1 },
  { name: "ä½¿ç”¨ç’°ä¿è¢‹", points: 1 },
  { name: "ç¨®æ¤ç¶ æ¤æ ½", points: 3 },
  { name: "å¤šåˆ©ç”¨è‡ªç„¶é€šé¢¨", points: 2 }
];

/* DOM */
const navHome = document.getElementById("nav-home");
const navHistory = document.getElementById("nav-history");
const navMedals = document.getElementById("nav-medals");
const pageHome = document.getElementById("page-home");
const pageHistory = document.getElementById("page-history");
const pageMedals = document.getElementById("page-medals");
const taskListEl = document.getElementById("task-list");
const noteEl = document.getElementById("note");
const saveBtn = document.getElementById("save-btn");
const todayPointsEl = document.getElementById("today-points");
const weekPointsEl = document.getElementById("week-points");
const weekPointsEl2 = document.getElementById("week-points-2");
const weeklyGoalLabel = document.getElementById("weekly-goal-label");
const weeklyGoalLabel2 = document.getElementById("weekly-goal-2");
const track = document.getElementById("track");
const walker = document.getElementById("walker");
const medalNote = document.getElementById("medal-note");
const historyListEl = document.getElementById("history-list");
const medalListEl = document.getElementById("medal-list");
const saveSound = document.getElementById("save-sound");

let currentPage = 1;
const PAGE_SIZE = 8;
let store = JSON.parse(localStorage.getItem(STORAGE_KEY) || "{}");

function ensureStore(){
  if (!store.weekStart) store.weekStart = getWeekStart();
  if (typeof store.weeklyTotal !== "number") store.weeklyTotal = 0;
  if (!store.tasksDone) store.tasksDone = {};
  if (!Array.isArray(store.history)) store.history = [];
  if (!Array.isArray(store.medals)) store.medals = [];
}
ensureStore();

if (store.weekStart !== getWeekStart()){
  store.weekStart = getWeekStart();
  store.weeklyTotal = 0;
  store.tasksDone = {};
  saveStore();
}

weeklyGoalLabel.textContent = WEEKLY_GOAL;
weeklyGoalLabel2.textContent = WEEKLY_GOAL;
renderTasks(); updatePoints(); renderWalker(); renderHistoryPage(); renderMedalsPage();

navHome.addEventListener("click", ()=> showPage("home"));
navHistory.addEventListener("click", ()=> { showPage("history"); renderHistoryPage(); });
navMedals.addEventListener("click", ()=> { showPage("medals"); renderMedalsPage(); });

function showPage(page){ pageHome.classList.add("hidden"); pageHistory.classList.add("hidden"); pageMedals.classList.add("hidden"); if (page === "home") pageHome.classList.remove("hidden"); if (page === "history") pageHistory.classList.remove("hidden"); if (page === "medals") pageMedals.classList.remove("hidden"); }

function renderTasks(){
  taskListEl.innerHTML = "";
  TASKS.forEach((t, idx)=>{
    const doneToday = store.tasksDone[idx] === getToday();
    const div = document.createElement("div"); div.className = "task";
    const left = document.createElement("div");
    left.innerHTML = `<div class="name">${t.name}</div><div class="points small muted">${t.points} é»</div>`;
    const btn = document.createElement("button"); btn.textContent = doneToday ? "å·²å®Œæˆ" : `+${t.points}`;
    if (doneToday) btn.disabled = true;
    btn.addEventListener("click", ()=> markTask(idx));
    div.appendChild(left); div.appendChild(btn); taskListEl.appendChild(div);
  });
}

function markTask(idx){
  const t = TASKS[idx];
  if (store.tasksDone[idx] === getToday()) return;
  // prevent exceeding weekly goal
  if (store.weeklyTotal + t.points > WEEKLY_GOAL){ alert(`åŠ ä¸Šæ­¤é …ç›®æœƒè¶…éæœ¬é€±ä¸Šé™ ${WEEKLY_GOAL} é»ï¼Œç„¡æ³•å†åŠ ã€‚`); return; }
  store.tasksDone[idx] = getToday();
  store.weeklyTotal += t.points; saveStore(); renderTasks(); updatePoints(); renderWalker();
}

saveBtn.addEventListener("click", saveTodayRecord);

function saveTodayRecord(){
  const today = getToday();
  const already = store.history.some(h => h.date === today);
  if (already) { alert("ä»Šå¤©å·²ç¶“å„²å­˜éç´€éŒ„å›‰ï¼"); return; }
  const actions = Object.keys(store.tasksDone).filter(i => store.tasksDone[i] === today).map(Number);
  const points = actions.reduce((s,i)=> s + TASKS[i].points, 0);
  const note = noteEl.value.trim();
  store.history.unshift({ date: today, actions, points, note, timestamp: new Date().toISOString() });
  try{ saveSound.currentTime = 0; saveSound.play(); } catch(e){}
  checkAndAwardMedal(); saveStore(); renderHistoryPage(); renderMedalsPage(); updatePoints(); renderTasks(); renderWalker(); alert("å·²å„²å­˜ä»Šå¤©çš„ç´€éŒ„ï¼");
}

function checkAndAwardMedal(){
  if (store.weeklyTotal >= WEEKLY_GOAL){
    const awarded = store.medals.some(m => m.weekStart === store.weekStart);
    if (!awarded){
      const msg = getRandomMsg();
      store.medals.unshift({ date: getToday(), weekStart: store.weekStart, points: store.weeklyTotal, message: msg, timestamp: new Date().toISOString() });
      saveStore();
      medalNote.textContent = `ğŸ‰ æ­å–œä½ ï¼Œæœ¬é€±å·²æˆåŠŸé”æˆ ${store.weeklyTotal} é»ï¼${msg}`;
      setTimeout(()=> medalNote.textContent = "", 8000);
    }
  }
}

function updatePoints(){
  const today = getToday();
  const todayPoints = Object.keys(store.tasksDone).reduce((s,k)=> store.tasksDone[k] === today ? s + TASKS[k].points : s, 0);
  todayPointsEl.textContent = todayPoints;
  weekPointsEl.textContent = store.weeklyTotal;
  weekPointsEl2.textContent = store.weeklyTotal;
}

function renderWalker(){ const trackWidth = Math.max(track.clientWidth - 48, 24); const ratio = Math.min(store.weeklyTotal / WEEKLY_GOAL, 1); walker.style.left = (8 + Math.round(ratio * trackWidth)) + "px"; }

function saveStore(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(store)); }

function renderHistoryPage(page = 1){
  const list = store.history || [];
  historyListEl.innerHTML = "";
  const totalPages = Math.max(1, Math.ceil(list.length / PAGE_SIZE));
  currentPage = Math.min(Math.max(1, page), totalPages);
  const slice = list.slice((currentPage-1)*PAGE_SIZE, currentPage*PAGE_SIZE);
  if (slice.length === 0){ historyListEl.innerHTML = "<p class='muted'>å°šç„¡æ­·å²ç´€éŒ„ï¼Œè«‹å›é¦–é å„²å­˜ä½ çš„ç¬¬ä¸€ç­†ç´€éŒ„ã€‚</p>"; }
  else { slice.forEach(item=>{ const div = document.createElement("div"); div.className = "history-item"; const names = item.actions.map(i=>TASKS[i].name).join("ã€") || "ï¼ˆç„¡ï¼‰"; div.innerHTML = `<div class="date">${item.date} â€” ${item.points} é»</div><div class="muted">è¡Œç‚ºï¼š${names}</div><div class="muted">å‚™è¨»ï¼š${item.note || "ï¼ˆç„¡ï¼‰"}</div>`; historyListEl.appendChild(div); }); }
  document.getElementById("page-info").textContent = `ç¬¬ ${currentPage} é  / ${totalPages} é `;
  document.getElementById("prev-page").disabled = currentPage <= 1;
  document.getElementById("next-page").disabled = currentPage >= totalPages;
}

document.getElementById("prev-page").addEventListener("click", ()=> renderHistoryPage(currentPage-1));
document.getElementById("next-page").addEventListener("click", ()=> renderHistoryPage(currentPage+1));

function renderMedalsPage(){ medalListEl.innerHTML = ""; if (!store.medals || store.medals.length === 0) { medalListEl.innerHTML = "<p class='muted'>å°šæœªå–å¾—ä»»ä½•çç‰Œ</p>"; return; } store.medals.forEach(m=>{ const div = document.createElement("div"); div.className = "history-item"; div.innerHTML = `<div class='date'>ğŸ… ${m.date}</div><div class='muted'>è©²é€±ç´¯ç© ${m.points} é»</div><div class='muted'>ğŸ’¬ æ­å–œä½ ï¼Œæœ¬é€±å·²æˆåŠŸé”æˆ ${m.points} é»ï¼ ${m.message || 'ç¹¼çºŒä¿æŒç¯€èƒ½å¥½ç¿’æ…£ï¼'}</div>`; medalListEl.appendChild(div); }); }

function getToday(){ return new Date().toISOString().slice(0,10); }
function getWeekStart(){ const d = new Date(); const day = d.getDay(); const diff = d.getDate() - day + (day === 0 ? -6 : 1); return new Date(d.getFullYear(), d.getMonth(), diff).toISOString().slice(0,10); }

// periodic week-check
setInterval(()=>{ const currentWeek = getWeekStart(); if (currentWeek !== store.weekStart){ store.weekStart = currentWeek; store.weeklyTotal = 0; store.tasksDone = {}; saveStore(); renderTasks(); updatePoints(); renderWalker(); renderHistoryPage(); renderMedalsPage(); } }, 60*1000);

// expose for debugging
window._energyTracker = { store, TASKS, saveStore };

// init
showPage("home");
</script>
</body>
</html>